<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CrowdSense - Disaster Simulation Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .map-container {
      height: 400px;
      border-radius: 8px;
      overflow: hidden;
    }
    .metrics-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }
    .simulation-card {
      background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
      color: white;
      border: none;
    }
    .alert-success {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .alert-danger {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .status-indicator {
      font-size: 1.2rem;
      font-weight: bold;
    }
    .last-updated {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .tweet-item {
      border-left: 4px solid #007bff;
      background-color: #f8f9fa;
    }
    .location-badge {
      background-color: #17a2b8;
      color: white;
      font-size: 0.75rem;
    }
    .simulation-badge {
      background-color: #ff6b35;
      color: white;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .disaster-btn {
      margin: 5px;
      min-width: 120px;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12 text-center">
        <h1 class="display-4">🌐 CrowdSense</h1>
        <p class="lead">Real-time Disaster Detection & Alert System</p>
        <span class="badge simulation-badge fs-6">🧪 SIMULATION MODE</span>
        <div class="last-updated mt-2">
          Last Updated: <span id="lastUpdated">{{ data.last_updated or 'Never' }}</span>
          <button id="refreshBtn" class="btn btn-sm btn-outline-primary ms-2">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Simulation Controls -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card simulation-card">
          <div class="card-header">
            <h5 class="mb-0">🧪 Disaster Simulation Controls</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <h6>Trigger Disaster Scenarios:</h6>
                <div class="btn-group-vertical d-md-none w-100" role="group">
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('earthquake', 'major')">
                    🌍 Major Earthquake
                  </button>
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('flood', 'severe')">
                    🌊 Severe Flood
                  </button>
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('fire', 'major')">
                    🔥 Major Wildfire
                  </button>
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('storm', 'severe')">
                    ⛈️ Severe Storm
                  </button>
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('tsunami', 'major')">
                    🌊 Major Tsunami
                  </button>
                </div>
                <div class="d-none d-md-block">
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('earthquake', 'major')">
                    🌍 Major Earthquake
                  </button>
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('flood', 'severe')">
                    🌊 Severe Flood
                  </button>
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('fire', 'major')">
                    🔥 Major Wildfire
                  </button>
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('storm', 'severe')">
                    ⛈️ Severe Storm
                  </button>
                  <button class="btn btn-outline-light disaster-btn" onclick="triggerDisaster('tsunami', 'major')">
                    🌊 Major Tsunami
                  </button>
                </div>
              </div>
              <div class="col-md-4">
                <h6>Active Scenarios:</h6>
                <div id="activeScenarios">
                  {% if data.active_scenarios %}
                    {% for scenario_id, scenario in data.active_scenarios.items() %}
                      <div class="badge bg-light text-dark me-1 mb-1">
                        {{ scenario.disaster_type.title() }} in {{ scenario.location }}
                      </div>
                    {% endfor %}
                  {% else %}
                    <small class="text-light">No active scenarios</small>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status and Metrics Row -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="alert text-center status-indicator
             {% if data.status == 'ALERT' %} alert-danger {% elif data.status == 'ERROR' %} alert-warning {% else %} alert-success {% endif %}">
          System Status: {{ data.status }}
          {% if data.error %}
            <br><small>{{ data.error }}</small>
          {% endif %}
        </div>
      </div>
      <div class="col-md-6">
        <div class="card metrics-card">
          <div class="card-body">
            <h6 class="card-title">System Metrics</h6>
            {% if data.stats %}
            <div class="row text-center">
              <div class="col-3">
                <div class="fw-bold">{{ data.stats.total_alerts or 0 }}</div>
                <small>Total Alerts</small>
              </div>
              <div class="col-3">
                <div class="fw-bold">{{ data.stats.total_tweets or 0 }}</div>
                <small>Total Tweets</small>
              </div>
              <div class="col-3">
                <div class="fw-bold">{{ data.stats.alerts_24h or 0 }}</div>
                <small>Alerts (24h)</small>
              </div>
              <div class="col-3">
                <div class="fw-bold">{{ data.stats.tweets_1h or 0 }}</div>
                <small>Tweets (1h)</small>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
      <!-- Left Column: Tweets and News -->
      <div class="col-lg-6">
        <!-- Tweets Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">📱 Recent Tweets</h5>
          </div>
          <div class="card-body" style="max-height: 400px; overflow-y: auto;">
            {% if data.tweets %}
              {% for tweet in data.tweets %}
              <div class="tweet-item p-3 mb-2 rounded">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <strong>{{ tweet.user or 'Unknown' }}</strong>
                    <p class="mb-1">{{ tweet.text }}</p>
                    {% if tweet.location %}
                      <span class="badge location-badge">📍 {{ tweet.location }}</span>
                    {% endif %}
                  </div>
                  <span class="badge bg-secondary">{{ tweet.sentiment or 'Neutral' }}</span>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">No recent tweets available. Trigger a disaster scenario to generate tweets!</p>
            {% endif %}
          </div>
        </div>

        <!-- News Section -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">📰 Recent Alerts & News</h5>
          </div>
          <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            {% if data.news %}
              {% for article in data.news %}
              <div class="border-bottom pb-2 mb-2">
                {{ article.headline }}
              </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">No recent alerts. Trigger a disaster scenario to generate alerts!</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Right Column: Map and Charts -->
      <div class="col-lg-6">
        <!-- Map Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">🗺️ Location Map</h5>
          </div>
          <div class="card-body">
            <div id="map" class="map-container"></div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">📊 Analytics</h5>
          </div>
          <div class="card-body">
            <canvas id="sentimentChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">🚨 Disaster Triggered!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="modalMessage">Disaster scenario has been triggered successfully!</p>
          <p class="text-muted">The system will now generate tweets and analyze for anomalies. You should receive an SMS alert shortly if the anomaly detection triggers.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Global variables
    let map;
    let sentimentChart;
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      initializeMap();
      initializeSentimentChart();
      setupAutoRefresh();
      
      // Manual refresh button
      document.getElementById('refreshBtn').addEventListener('click', refreshData);
    });

    function initializeMap() {
      // Initialize Leaflet map
      map = L.map('map').setView([20.0, 0.0], 2);
      
      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      
      // Load initial map data
      loadMapData();
    }

    function loadMapData() {
      fetch('/api/map-data')
        .then(response => response.json())
        .then(data => {
          // Clear existing markers
          map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });
          
          // Add new markers
          data.points.forEach(point => {
            const marker = L.marker([point.lat, point.lng]).addTo(map);
            
            // Create popup content
            const popupContent = `
              <strong>${point.location || 'Unknown Location'}</strong><br>
              <em>Keyword: ${point.keyword}</em><br>
              ${point.text}<br>
              <small>${point.created_at}</small>
            `;
            
            marker.bindPopup(popupContent);
          });
          
          // Fit map to show all markers if there are any
          if (data.points.length > 0) {
            const group = new L.featureGroup(map._layers);
            if (Object.keys(group._layers).length > 0) {
              map.fitBounds(group.getBounds().pad(0.1));
            }
          }
        })
        .catch(error => {
          console.error('Error loading map data:', error);
        });
    }

    function initializeSentimentChart() {
      const tweetData = {{ data.tweets | tojson }};
      
      // Count sentiments
      let positive = 0, negative = 0, neutral = 0;
      tweetData.forEach(tweet => {
        const sentiment = tweet.sentiment || 'Neutral';
        if (sentiment === 'Positive') positive++;
        else if (sentiment === 'Negative') negative++;
        else neutral++;
      });

      const ctx = document.getElementById('sentimentChart').getContext('2d');
      sentimentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Positive', 'Negative', 'Neutral'],
          datasets: [{
            data: [positive, negative, neutral],
            backgroundColor: ['#28a745', '#dc3545', '#6c757d'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function triggerDisaster(disasterType, severity) {
      // Disable button temporarily
      event.target.disabled = true;
      event.target.innerHTML = '⏳ Triggering...';
      
      fetch('/api/simulation/trigger', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          disaster_type: disasterType,
          severity: severity
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success modal
          document.getElementById('modalMessage').textContent = data.message;
          new bootstrap.Modal(document.getElementById('successModal')).show();
          
          // Refresh data after a short delay
          setTimeout(() => {
            refreshData();
          }, 3000);
        } else {
          alert('Error triggering disaster: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error triggering disaster simulation');
      })
      .finally(() => {
        // Re-enable button
        setTimeout(() => {
          event.target.disabled = false;
          event.target.innerHTML = event.target.innerHTML.replace('⏳ Triggering...', 
            event.target.innerHTML.includes('Earthquake') ? '🌍 Major Earthquake' :
            event.target.innerHTML.includes('Flood') ? '🌊 Severe Flood' :
            event.target.innerHTML.includes('Fire') ? '🔥 Major Wildfire' :
            event.target.innerHTML.includes('Storm') ? '⛈️ Severe Storm' :
            '🌊 Major Tsunami');
        }, 2000);
      });
    }

    function refreshData() {
      fetch('/api/data')
        .then(response => response.json())
        .then(data => {
          // Update last updated time
          document.getElementById('lastUpdated').textContent = data.last_updated || 'Unknown';
          
          // Reload the page with new data
          location.reload();
        })
        .catch(error => {
          console.error('Error refreshing data:', error);
        });
    }

    function setupAutoRefresh() {
      // Auto-refresh every 30 seconds in simulation mode
      setInterval(() => {
        loadMapData();
        // Could also update other components here without full page reload
      }, 30 * 1000);
    }
  </script>

</body>
</html>
